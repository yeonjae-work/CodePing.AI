name: ðŸš€ CodePing.AI CD Pipeline

on:
  workflow_run:
    workflows: ["ðŸš€ CodePing.AI CI Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force_deploy:
        description: 'Force deployment (skip some checks)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ðŸ” ë°°í¬ ì „ ê²€ì¦
  pre-deployment-check:
    name: ðŸ” Pre-deployment Check
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    outputs:
      deploy_environment: ${{ steps.determine-env.outputs.environment }}
      deploy_version: ${{ steps.version.outputs.version }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Determine deployment environment
      id: determine-env
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸ·ï¸ Generate version
      id: version
      run: |
        if [ "${{ github.ref_name }}" == "main" ]; then
          VERSION="v$(date +%Y%m%d)-$(echo ${{ github.sha }} | cut -c1-8)"
        else
          VERSION="dev-$(echo ${{ github.sha }} | cut -c1-8)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
        
    - name: ðŸ“Š Validate deployment readiness
      run: |
        echo "ðŸ” Checking deployment readiness..."
        echo "- Environment: ${{ steps.determine-env.outputs.environment }}"
        echo "- Version: ${{ steps.version.outputs.version }}"
        echo "- Commit: ${{ github.sha }}"
        echo "- Force deploy: ${{ github.event.inputs.force_deploy }}"
        
        # PyPI íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ì²´í¬
        python -m pip install --upgrade pip
        pip install -r requirements.txt --dry-run
        echo "âœ… Dependencies check passed"

  # ðŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=${{ needs.pre-deployment-check.outputs.deploy_version }}
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: ðŸ”¨ Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
        
    - name: ðŸ“Š Image security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment-check.outputs.deploy_version }}
        format: 'sarif'
        output: 'trivy-image-results.sarif'
        
    - name: ðŸ“Š Upload image scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-image-results.sarif'

  # ðŸ—ï¸ Staging ë°°í¬
  deploy-staging:
    name: ðŸ—ï¸ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, build-and-push]
    if: needs.pre-deployment-check.outputs.deploy_environment == 'staging' || needs.pre-deployment-check.outputs.deploy_environment == 'production'
    
    environment:
      name: staging
      url: https://staging.codeping.ai
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Set up deployment configs
      run: |
        mkdir -p deployment/staging
        cat > deployment/staging/docker-compose.yml << EOF
        version: '3.8'
        services:
          app:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment-check.outputs.deploy_version }}
            ports:
              - "8000:8000"
            environment:
              - ENVIRONMENT=staging
              - DATABASE_URL=\${DATABASE_URL}
              - GITHUB_WEBHOOK_SECRET=\${GITHUB_WEBHOOK_SECRET}
              - SLACK_WEBHOOK_URL=\${SLACK_WEBHOOK_URL}
              - OPENAI_API_KEY=\${OPENAI_API_KEY}
            restart: unless-stopped
            healthcheck:
              test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
              interval: 30s
              timeout: 10s
              retries: 3
              
          postgres:
            image: postgres:15
            environment:
              - POSTGRES_DB=codeping_staging
              - POSTGRES_USER=\${POSTGRES_USER}
              - POSTGRES_PASSWORD=\${POSTGRES_PASSWORD}
            volumes:
              - postgres_data:/var/lib/postgresql/data
            restart: unless-stopped
            
        volumes:
          postgres_data:
        EOF
        
    - name: ðŸš€ Deploy to staging
      run: |
        echo "ðŸš€ Deploying to staging environment..."
        echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment-check.outputs.deploy_version }}"
        echo "ðŸ·ï¸ Version: ${{ needs.pre-deployment-check.outputs.deploy_version }}"
        
        # ì‹¤ì œ ë°°í¬ ë¡œì§ì€ ì—¬ê¸°ì— êµ¬í˜„
        # ì˜ˆ: SSHë¡œ ì„œë²„ì— ì ‘ì†í•˜ì—¬ docker-compose up
        echo "âœ… Staging deployment completed"
        
    - name: ðŸ§ª Run smoke tests
      run: |
        echo "ðŸ§ª Running smoke tests on staging..."
        
        # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
        echo "ðŸ” Health check test"
        # curl -f https://staging.codeping.ai/health || exit 1
        
        # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        echo "ðŸ” API endpoint test"
        # curl -f https://staging.codeping.ai/api/status || exit 1
        
        echo "âœ… Smoke tests passed"

  # ðŸŽ¯ Production ë°°í¬ (ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”)
  deploy-production:
    name: ðŸŽ¯ Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, build-and-push, deploy-staging]
    if: needs.pre-deployment-check.outputs.deploy_environment == 'production' && needs.deploy-staging.result == 'success'
    
    environment:
      name: production
      url: https://codeping.ai
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Set up production configs
      run: |
        mkdir -p deployment/production
        cat > deployment/production/docker-compose.yml << EOF
        version: '3.8'
        services:
          app:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment-check.outputs.deploy_version }}
            ports:
              - "8000:8000"
            environment:
              - ENVIRONMENT=production
              - DATABASE_URL=\${DATABASE_URL}
              - GITHUB_WEBHOOK_SECRET=\${GITHUB_WEBHOOK_SECRET}
              - SLACK_WEBHOOK_URL=\${SLACK_WEBHOOK_URL}
              - OPENAI_API_KEY=\${OPENAI_API_KEY}
            restart: unless-stopped
            deploy:
              replicas: 3
              resources:
                limits:
                  memory: 1G
                  cpus: '0.5'
            healthcheck:
              test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
              interval: 30s
              timeout: 10s
              retries: 3
              
          postgres:
            image: postgres:15
            environment:
              - POSTGRES_DB=codeping_production
              - POSTGRES_USER=\${POSTGRES_USER}
              - POSTGRES_PASSWORD=\${POSTGRES_PASSWORD}
            volumes:
              - postgres_data:/var/lib/postgresql/data
            restart: unless-stopped
            
          redis:
            image: redis:7-alpine
            restart: unless-stopped
            
        volumes:
          postgres_data:
        EOF
        
    - name: ðŸš€ Deploy to production
      run: |
        echo "ðŸš€ Deploying to production environment..."
        echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment-check.outputs.deploy_version }}"
        echo "ðŸ·ï¸ Version: ${{ needs.pre-deployment-check.outputs.deploy_version }}"
        
        # Blue-Green ë°°í¬ ë˜ëŠ” Rolling ì—…ë°ì´íŠ¸ ë¡œì§
        echo "ðŸ”„ Performing rolling update..."
        
        # ì‹¤ì œ ë°°í¬ ë¡œì§ì€ ì—¬ê¸°ì— êµ¬í˜„
        echo "âœ… Production deployment completed"
        
    - name: ðŸ§ª Run production smoke tests
      run: |
        echo "ðŸ§ª Running production smoke tests..."
        
        # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
        echo "ðŸ” Health check test"
        # curl -f https://codeping.ai/health || exit 1
        
        # í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        echo "ðŸ” Core functionality test"
        # curl -f https://codeping.ai/api/status || exit 1
        
        echo "âœ… Production smoke tests passed"

  # ðŸ“Š ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
  post-deployment-monitoring:
    name: ðŸ“Š Post-deployment Monitoring
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, deploy-staging]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    
    steps:
    - name: ðŸ“Š Monitor deployment health
      run: |
        echo "ðŸ“Š Starting post-deployment monitoring..."
        
        ENV="${{ needs.pre-deployment-check.outputs.deploy_environment }}"
        VERSION="${{ needs.pre-deployment-check.outputs.deploy_version }}"
        
        echo "ðŸ” Monitoring environment: $ENV"
        echo "ðŸ·ï¸ Deployed version: $VERSION"
        
        # 5ë¶„ê°„ í—¬ìŠ¤ì²´í¬ ëª¨ë‹ˆí„°ë§
        for i in {1..10}; do
          echo "ðŸ” Health check attempt $i/10"
          # ì‹¤ì œ í—¬ìŠ¤ì²´í¬ ë¡œì§
          sleep 30
        done
        
        echo "âœ… Post-deployment monitoring completed"
        
    - name: ðŸ“ˆ Performance baseline check
      run: |
        echo "ðŸ“ˆ Checking performance baseline..."
        
        # ì‘ë‹µì‹œê°„, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë“± ê¸°ë³¸ ì„±ëŠ¥ ì§€í‘œ ì²´í¬
        echo "ðŸ” Response time check"
        echo "ðŸ” Memory usage check"
        echo "ðŸ” CPU usage check"
        
        echo "âœ… Performance baseline within acceptable range"

  # ðŸ”„ ë¡¤ë°± ì¤€ë¹„
  prepare-rollback:
    name: ðŸ”„ Prepare Rollback
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, deploy-staging]
    if: failure()
    
    steps:
    - name: ðŸ”„ Prepare rollback strategy
      run: |
        echo "ðŸ”„ Preparing rollback strategy..."
        
        # ì´ì „ ë²„ì „ ì •ë³´ ì¡°íšŒ
        echo "ðŸ” Finding previous stable version..."
        
        # ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„
        echo "ðŸ“ Preparing rollback scripts..."
        
        echo "âš ï¸ Rollback prepared. Manual intervention may be required."

  # ðŸ“± ë°°í¬ ì•Œë¦¼
  deployment-notification:
    name: ðŸ“± Deployment Notification
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: ðŸ“± Send success notification
      if: needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success'
      run: |
        ENV="${{ needs.pre-deployment-check.outputs.deploy_environment }}"
        VERSION="${{ needs.pre-deployment-check.outputs.deploy_version }}"
        
        echo "âœ… Deployment successful!"
        echo "ðŸŽ¯ Environment: $ENV"
        echo "ðŸ·ï¸ Version: $VERSION"
        echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION"
        echo "ðŸ”— URL: https://$( [ "$ENV" = "production" ] && echo "codeping.ai" || echo "staging.codeping.ai" )"
        
    - name: ðŸ“± Send failure notification
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "ðŸ”§ Please check the logs and fix the issues"
        echo "ðŸ”„ Rollback may be required" 