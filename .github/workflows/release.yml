name: ğŸ·ï¸ Release Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version type'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch
      pre_release:
        description: 'Pre-release'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ğŸ·ï¸ ë²„ì „ ê´€ë¦¬ ë° íƒœê·¸ ìƒì„±
  version-management:
    name: ğŸ·ï¸ Version Management
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”§ Install version management tools
      run: |
        pip install bump2version gitpython
        
    - name: ğŸ·ï¸ Generate new version
      id: version
      run: |
        # í˜„ì¬ ë²„ì „ í™•ì¸
        CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Current version: $CURRENT_VERSION"
        
        # ìƒˆ ë²„ì „ ê³„ì‚°
        VERSION_TYPE="${{ github.event.inputs.version_type }}"
        
        # ë²„ì „ íŒŒì¼ ìƒì„± (ì—†ëŠ” ê²½ìš°)
        if [ ! -f .bumpversion.cfg ]; then
          cat > .bumpversion.cfg << EOF
        [bumpversion]
        current_version = 0.1.0
        commit = True
        tag = True
        tag_name = v{new_version}
        
        [bumpversion:file:VERSION]
        EOF
        fi
        
        if [ ! -f VERSION ]; then
          echo "0.1.0" > VERSION
        fi
        
        # ë²„ì „ ì—…ë°ì´íŠ¸
        bump2version $VERSION_TYPE --dry-run --list | grep new_version= | cut -d= -f2 > new_version.txt
        NEW_VERSION=$(cat new_version.txt)
        
        echo "new_version=v$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version: v$NEW_VERSION"
        
    - name: ğŸ“ Generate changelog
      id: changelog
      run: |
        echo "ğŸ“ Generating changelog..."
        
        # ì´ì „ íƒœê·¸ë¶€í„° í˜„ì¬ê¹Œì§€ì˜ ì»¤ë°‹ ë¡œê·¸ ìˆ˜ì§‘
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
        
        cat > CHANGELOG_TEMP.md << EOF
        # Changelog for ${{ steps.version.outputs.new_version }}
        
        ## ğŸš€ ìƒˆë¡œìš´ ê¸°ëŠ¥
        EOF
        
        # feat: ì»¤ë°‹ë“¤ ì¶”ì¶œ
        git log $LAST_TAG..HEAD --oneline --grep="feat:" --pretty=format:"- %s" >> CHANGELOG_TEMP.md
        
        cat >> CHANGELOG_TEMP.md << EOF
        
        ## ğŸ› ë²„ê·¸ ìˆ˜ì •
        EOF
        
        # fix: ì»¤ë°‹ë“¤ ì¶”ì¶œ
        git log $LAST_TAG..HEAD --oneline --grep="fix:" --pretty=format:"- %s" >> CHANGELOG_TEMP.md
        
        cat >> CHANGELOG_TEMP.md << EOF
        
        ## ğŸ”§ ê°œì„ ì‚¬í•­
        EOF
        
        # refactor:, perf:, style: ì»¤ë°‹ë“¤ ì¶”ì¶œ
        git log $LAST_TAG..HEAD --oneline --grep="refactor:\|perf:\|style:" --pretty=format:"- %s" >> CHANGELOG_TEMP.md
        
        cat >> CHANGELOG_TEMP.md << EOF
        
        ## ğŸ“š ë¬¸ì„œ
        EOF
        
        # docs: ì»¤ë°‹ë“¤ ì¶”ì¶œ
        git log $LAST_TAG..HEAD --oneline --grep="docs:" --pretty=format:"- %s" >> CHANGELOG_TEMP.md
        
        # ë³€ê²½ì‚¬í•­ì„ GitHub Outputìœ¼ë¡œ ì„¤ì •
        CHANGELOG_CONTENT=$(cat CHANGELOG_TEMP.md)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ·ï¸ Create and push tag
      run: |
        NEW_VERSION="${{ steps.version.outputs.new_version }}"
        
        # Git ì„¤ì •
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # ë²„ì „ íŒŒì¼ ì—…ë°ì´íŠ¸
        echo "${NEW_VERSION#v}" > VERSION
        git add VERSION .bumpversion.cfg
        
        # ì»¤ë°‹ ë° íƒœê·¸ ìƒì„±
        git commit -m "chore: bump version to $NEW_VERSION"
        git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
        
        # í‘¸ì‹œ
        git push origin main
        git push origin "$NEW_VERSION"

  # ğŸ“¦ ë¦´ë¦¬ìŠ¤ ë¹Œë“œ
  build-release:
    name: ğŸ“¦ Build Release
    runs-on: ubuntu-latest
    needs: version-management
    if: always() && (needs.version-management.result == 'success' || github.event_name == 'push')
    
    outputs:
      release_version: ${{ steps.get-version.outputs.version }}
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Get version
      id: get-version
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="${{ needs.version-management.outputs.new_version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”§ Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        
    - name: ğŸ“¦ Build distribution packages
      run: |
        # ë¦´ë¦¬ìŠ¤ìš© ì„¤ì • íŒŒì¼ ìƒì„±
        cat > pyproject.toml << EOF
        [build-system]
        requires = ["setuptools>=45", "wheel", "setuptools_scm"]
        build-backend = "setuptools.build_meta"
        
        [project]
        name = "codeping-ai"
        version = "${{ steps.get-version.outputs.version }}"
        description = "AI-driven code change monitoring and notification system"
        readme = "README.md"
        authors = [
            {name = "CodePing.AI Team", email = "team@codeping.ai"}
        ]
        license = {text = "MIT"}
        classifiers = [
            "Development Status :: 4 - Beta",
            "Intended Audience :: Developers",
            "License :: OSI Approved :: MIT License",
            "Programming Language :: Python :: 3",
            "Programming Language :: Python :: 3.11",
            "Programming Language :: Python :: 3.12",
        ]
        requires-python = ">=3.11"
        dependencies = [
            "fastapi>=0.100.0",
            "uvicorn>=0.22.0",
            "sqlalchemy>=2.0.0",
            "pydantic>=2.0.0",
        ]
        
        [project.urls]
        Homepage = "https://github.com/yeonjae-work/CodePing.AI"
        Repository = "https://github.com/yeonjae-work/CodePing.AI"
        Issues = "https://github.com/yeonjae-work/CodePing.AI/issues"
        EOF
        
        # ë¹Œë“œ ì‹¤í–‰
        python -m build
        
    - name: ğŸ“Š Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-distributions
        path: dist/

  # ğŸ³ ë¦´ë¦¬ìŠ¤ Docker ì´ë¯¸ì§€
  build-release-docker:
    name: ğŸ³ Build Release Docker Image
    runs-on: ubuntu-latest
    needs: build-release
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=tag
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ needs.build-release.outputs.release_version }}
          
    - name: ğŸ”¨ Build and push release image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  # ğŸ“„ GitHub ë¦´ë¦¬ìŠ¤ ìƒì„±
  create-github-release:
    name: ğŸ“„ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version-management, build-release, build-release-docker]
    if: always() && (needs.build-release.result == 'success')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: release-distributions
        path: dist/
        
    - name: ğŸ“„ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.build-release.outputs.release_version }}
        name: "Release ${{ needs.build-release.outputs.release_version }}"
        body: |
          # ğŸ‰ CodePing.AI ${{ needs.build-release.outputs.release_version }}
          
          ${{ needs.version-management.outputs.changelog || 'ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!' }}
          
          ## ğŸ“¦ ì„¤ì¹˜ ë°©ë²•
          
          ### Docker ì‚¬ìš©
          ```bash
          docker pull ghcr.io/${{ github.repository }}:${{ needs.build-release.outputs.release_version }}
          ```
          
          ### PyPI íŒ¨í‚¤ì§€ ì‚¬ìš©
          ```bash
          pip install codeping-ai==${{ needs.build-release.outputs.release_version }}
          ```
          
          ## ğŸš€ ë°°í¬ëœ PyPI íŒ¨í‚¤ì§€ë“¤
          - yeonjae-universal-data-storage
          - yeonjae-universal-webhook-receiver
          - yeonjae-universal-git-data-parser
          - yeonjae-universal-notification-service
          - ê·¸ ì™¸ 8ê°œ íŒ¨í‚¤ì§€
          
          ## ğŸ”— ìœ ìš©í•œ ë§í¬
          - [ë¬¸ì„œ](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [ì˜ˆì œ](https://github.com/${{ github.repository }}/tree/main/examples)
          - [ì´ìŠˆ ë¦¬í¬íŠ¸](https://github.com/${{ github.repository }}/issues)
          
        files: |
          dist/*
        draft: false
        prerelease: ${{ github.event.inputs.pre_release == 'true' }}
        generate_release_notes: true

  # ğŸ“Š ë¦´ë¦¬ìŠ¤ í›„ ì‘ì—…
  post-release:
    name: ğŸ“Š Post-release Tasks
    runs-on: ubuntu-latest
    needs: [create-github-release]
    if: needs.create-github-release.result == 'success'
    
    steps:
    - name: ğŸ“Š Update release metrics
      run: |
        echo "ğŸ“Š Updating release metrics..."
        echo "ğŸ·ï¸ Version: ${{ needs.build-release.outputs.release_version }}"
        echo "ğŸ“… Release date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "ğŸ³ Docker image: ghcr.io/${{ github.repository }}:${{ needs.build-release.outputs.release_version }}"
        
    - name: ğŸ“± Send release notification
      run: |
        echo "ğŸ“± Sending release notification..."
        echo "âœ… Release ${{ needs.build-release.outputs.release_version }} completed successfully!"
        echo "ğŸ‰ CodePing.AI is now available with the latest features and improvements!" 