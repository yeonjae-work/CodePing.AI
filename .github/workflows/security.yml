name: ğŸ” Security Scanning

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (UTC)ì— ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ğŸ” ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”
  dependency-scan:
    name: ğŸ” Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety pip-audit
        
    - name: ğŸ”’ Safety vulnerability check
      run: |
        safety check --json --output safety-report.json || true
        safety check --short-report
        
    - name: ğŸ” Pip-audit vulnerability check
      run: |
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit --desc
        
    - name: ğŸ“Š Upload vulnerability reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-vulnerability-reports
        path: |
          safety-report.json
          pip-audit-report.json

  # ğŸ›¡ï¸ ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº”
  code-security-scan:
    name: ğŸ›¡ï¸ Code Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”§ Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit semgrep
        
    - name: ğŸ›¡ï¸ Bandit security scan
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . --severity-level medium --confidence-level medium
        
    - name: ğŸ” Semgrep security scan
      run: |
        semgrep --config=auto --json --output=semgrep-report.json . || true
        semgrep --config=auto --severity=ERROR .
        
    - name: ğŸ“Š Upload security scan reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-security-reports
        path: |
          bandit-report.json
          semgrep-report.json

  # ğŸ³ Docker ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº”
  docker-security-scan:
    name: ğŸ³ Docker Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”¨ Build Docker image for scanning
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: codeping-ai:security-scan
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ” Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'codeping-ai:security-scan'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ” Trivy filesystem scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'trivy-fs-results.json'
        
    - name: ğŸ” Docker Scout scan
      uses: docker/scout-action@v1
      with:
        command: cves
        image: codeping-ai:security-scan
        format: sarif
        output: scout-results.sarif
        
    - name: ğŸ“Š Upload Trivy scan results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: ğŸ“Š Upload Docker Scout results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'scout-results.sarif'
        
    - name: ğŸ“Š Upload security scan artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: docker-security-reports
        path: |
          trivy-results.sarif
          trivy-fs-results.json
          scout-results.sarif

  # ğŸ” ì‹œí¬ë¦¿ ìŠ¤ìº”
  secrets-scan:
    name: ğŸ” Secrets Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ” TruffleHog secrets scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
        
    - name: ğŸ” GitLeaks secrets scan
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ğŸ“Š ë³´ì•ˆ ìš”ì•½ ë¦¬í¬íŠ¸
  security-summary:
    name: ğŸ“Š Security Summary Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security-scan, docker-security-scan, secrets-scan]
    if: always()
    
    steps:
    - name: ğŸ“¥ Download all security reports
      uses: actions/download-artifact@v3
      with:
        path: security-reports/
        
    - name: ğŸ“Š Generate security summary
      run: |
        echo "# ğŸ” Security Scan Summary Report" > security-summary.md
        echo "" >> security-summary.md
        echo "ğŸ“… **Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-summary.md
        echo "ğŸ”— **Commit:** ${{ github.sha }}" >> security-summary.md
        echo "ğŸŒ¿ **Branch:** ${{ github.ref_name }}" >> security-summary.md
        echo "" >> security-summary.md
        
        echo "## ğŸ“Š Scan Results" >> security-summary.md
        echo "" >> security-summary.md
        echo "| Scan Type | Status | Details |" >> security-summary.md
        echo "|-----------|--------|---------|" >> security-summary.md
        
        # ì˜ì¡´ì„± ìŠ¤ìº” ê²°ê³¼
        if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
          echo "| ğŸ” Dependency Scan | âœ… Passed | No critical vulnerabilities found |" >> security-summary.md
        else
          echo "| ğŸ” Dependency Scan | âŒ Failed | Critical vulnerabilities detected |" >> security-summary.md
        fi
        
        # ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼
        if [ "${{ needs.code-security-scan.result }}" == "success" ]; then
          echo "| ğŸ›¡ï¸ Code Security Scan | âœ… Passed | No security issues found |" >> security-summary.md
        else
          echo "| ğŸ›¡ï¸ Code Security Scan | âŒ Failed | Security issues detected |" >> security-summary.md
        fi
        
        # Docker ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼
        if [ "${{ needs.docker-security-scan.result }}" == "success" ]; then
          echo "| ğŸ³ Docker Security Scan | âœ… Passed | No container vulnerabilities |" >> security-summary.md
        else
          echo "| ğŸ³ Docker Security Scan | âŒ Failed | Container vulnerabilities found |" >> security-summary.md
        fi
        
        # ì‹œí¬ë¦¿ ìŠ¤ìº” ê²°ê³¼
        if [ "${{ needs.secrets-scan.result }}" == "success" ]; then
          echo "| ğŸ” Secrets Scan | âœ… Passed | No exposed secrets |" >> security-summary.md
        else
          echo "| ğŸ” Secrets Scan | âŒ Failed | Potential secrets detected |" >> security-summary.md
        fi
        
        echo "" >> security-summary.md
        echo "## ğŸ”§ Recommendations" >> security-summary.md
        echo "" >> security-summary.md
        
        # ì‹¤íŒ¨í•œ ìŠ¤ìº”ì´ ìˆëŠ” ê²½ìš° ê¶Œì¥ì‚¬í•­ ì¶”ê°€
        if [ "${{ needs.dependency-scan.result }}" != "success" ] || \
           [ "${{ needs.code-security-scan.result }}" != "success" ] || \
           [ "${{ needs.docker-security-scan.result }}" != "success" ] || \
           [ "${{ needs.secrets-scan.result }}" != "success" ]; then
          echo "âš ï¸ **Security issues detected!** Please review the detailed reports and take appropriate action:" >> security-summary.md
          echo "" >> security-summary.md
          echo "1. ğŸ“¥ Download detailed reports from the Actions artifacts" >> security-summary.md
          echo "2. ğŸ” Review each vulnerability and assess its impact" >> security-summary.md
          echo "3. ğŸ”§ Update dependencies to patched versions" >> security-summary.md
          echo "4. ğŸ›¡ï¸ Fix code security issues identified by static analysis" >> security-summary.md
          echo "5. ğŸ” Remove or secure any exposed secrets" >> security-summary.md
          echo "6. ğŸ³ Update base Docker images to latest secure versions" >> security-summary.md
        else
          echo "âœ… **All security scans passed!** Your codebase appears to be secure." >> security-summary.md
          echo "" >> security-summary.md
          echo "ğŸ”„ **Next steps:**" >> security-summary.md
          echo "- Continue regular security scanning" >> security-summary.md
          echo "- Keep dependencies up to date" >> security-summary.md
          echo "- Monitor for new vulnerabilities" >> security-summary.md
        fi
        
        echo "" >> security-summary.md
        echo "## ğŸ“ Available Reports" >> security-summary.md
        echo "" >> security-summary.md
        echo "- ğŸ“Š Dependency vulnerability reports (Safety, pip-audit)" >> security-summary.md
        echo "- ğŸ›¡ï¸ Code security reports (Bandit, Semgrep)" >> security-summary.md
        echo "- ğŸ³ Docker security reports (Trivy, Docker Scout)" >> security-summary.md
        echo "- ğŸ” Secrets scan reports (TruffleHog, GitLeaks)" >> security-summary.md
        
        cat security-summary.md
        
    - name: ğŸ“Š Upload security summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary-report
        path: security-summary.md

  # ğŸš¨ ë³´ì•ˆ ì•Œë¦¼
  security-notification:
    name: ğŸš¨ Security Notification
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security-scan, docker-security-scan, secrets-scan]
    if: failure() && github.event_name == 'schedule'
    
    steps:
    - name: ğŸš¨ Send security alert
      run: |
        echo "ğŸš¨ SECURITY ALERT: Critical security issues detected!"
        echo ""
        echo "ğŸ“Š Scan Results:"
        echo "- Dependency Scan: ${{ needs.dependency-scan.result }}"
        echo "- Code Security Scan: ${{ needs.code-security-scan.result }}"
        echo "- Docker Security Scan: ${{ needs.docker-security-scan.result }}"
        echo "- Secrets Scan: ${{ needs.secrets-scan.result }}"
        echo ""
        echo "ğŸ”§ Immediate action required:"
        echo "1. Review the security reports in GitHub Actions"
        echo "2. Address all critical and high-severity vulnerabilities"
        echo "3. Update dependencies and fix security issues"
        echo "4. Re-run security scans to verify fixes"
        echo ""
        echo "ğŸ”— View detailed reports: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # ğŸ”„ ìë™ ë³´ì•ˆ ì—…ë°ì´íŠ¸ (ì˜ì¡´ì„±)
  auto-security-update:
    name: ğŸ”„ Auto Security Update
    runs-on: ubuntu-latest
    needs: [dependency-scan]
    if: needs.dependency-scan.result == 'failure' && github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”§ Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools safety
        
    - name: ğŸ”„ Update vulnerable dependencies
      run: |
        echo "ğŸ”„ Checking for security updates..."
        
        # í˜„ì¬ ì·¨ì•½ì  í™•ì¸
        safety check --json --output current-vulns.json || true
        
        # requirements.txt ë°±ì—…
        cp requirements.txt requirements.txt.backup
        
        # ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì‹œë„
        pip-compile --upgrade requirements.in || pip-compile --upgrade
        
        # ì—…ë°ì´íŠ¸ í›„ ì·¨ì•½ì  ì¬í™•ì¸
        pip install -r requirements.txt
        safety check --json --output updated-vulns.json || true
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if ! diff -q requirements.txt requirements.txt.backup > /dev/null; then
          echo "ğŸ“¦ Dependencies updated for security patches"
          
          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ì»¤ë°‹ ë° í‘¸ì‹œ
          git add requirements.txt
          git commit -m "security: auto-update vulnerable dependencies
          
          - Updated dependencies to address security vulnerabilities
          - Automated security patch via GitHub Actions
          - Previous vulnerabilities: $(cat current-vulns.json | jq -r '.vulnerabilities | length // 0') found
          - Updated vulnerabilities: $(cat updated-vulns.json | jq -r '.vulnerabilities | length // 0') found"
          
          git push origin main
          
          echo "âœ… Security updates applied and committed"
        else
          echo "â„¹ï¸ No dependency updates available"
        fi 